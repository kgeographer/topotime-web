<meta charset="utf-8">
<head>
<title>computing place:: topotime v0.1 alpha</title>
	<link rel="stylesheet" href="css/pepper-grinder/jquery-ui-1.8.23.custom.css" />
	<script src="https://code.jquery.com/jquery-1.9.1.js"></script>
	<script src="https://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
	<script src="js/d3v3/d3.v3.min.js"></script>
	<script src="js/ttdemo.js"></script>
	<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
	<link type="text/css" rel="stylesheet" href="css/ttweb.css" />
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
 <!--[if lte IE 8]>
   <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
 <![endif]-->
	<!--<script src="data/out_geom_d3.json"></script>
	<script src="data/polys.js"></script>-->
</head>
<body onload="setDates()">
<div id="header">
	<span id="sitetitle">Topotime</span><span id="sitesubtitle"> temporal geometry browser</span><span id="datatitle"></span>
</div>
<div class="ui-widget" id="left">
	<div class="controls">
	<p><select id="sel_case">
		<!--# topotime_format pleiades98test Dance us_history ww2b; ORIGINAL tests: ww2a pleiades -->
		<option value="pleiades98test" selected="selected">Pleiades periods</option>
		<option value="topotime_format">Topotime spec</option>
		<option value="Dance_adj">George Dance the Younger</option>
		<option value="us_history">Some U.S. history</option>
		<option value="ww2func">A WW II scenario</option>
	</select></p>
	</div>
	<div class="controls">
		<div class="d_calc">
		<form id="calc_form">
		<p><span class="help">start/end values: ([-]Y{1,7}[-MM][-DD])</span></p>
		<p><label for="start">Start date </label>
		<input id="i_start" type="text" name="start" value=""> <br/>
		<label for="end">End date</label>
		<input id="i_end" type="text" name="end" value=""></p>
		<input type="submit" id="b_calc" value="Calculate intersection">
		</form>
		</div>
		<div class="d_search">
		<p><input id="i_search" type="text" value="" size="15">
		<input type="submit" id="b_search" name="Search" value="Search" >
		<input type="submit" id="b_reset" value="Reset" onclick=resetGeometry() ></p>
		</div>
	</div>
	<div><h4>Results</h4><p id="results"></p></div>
</div>
<div id="right">
	<div id="d_geomvis"></div>
	<div>
		<div id="d_periodlist"></div>
		<div id="d_map">map</div>
	</div>
</div>
<script>
dateHash={
	"ww2func":{"s":"1945-03-21","e":"1945-09-20"},
	"ww2":{"s":"1945-03-21","e":"1945-09-20"},
	"pleiades":{"s":"-200", "e":"50"},
	"pleiades98test":{"s":"-200", "e":"50"},
	"Dance_adj":{"s":"1761-03-21","e":"1761-09-20"},
	"topotime_format":{"s":"1929-10-29","e":"1933-03-15"},
	"us_history":{"s":"1778-01-01","e":"1800-01-01"}}
	
setDates = function(){
	$('#i_start').val( dateHash[$('#sel_case').val()]['s'] );
	$('#i_end').val( dateHash[$('#sel_case').val()]['e'] );
}
$('#calc_form').submit(function() {
	$('#results').html("");
	$.ajax(
		{
		type: "get",
		url: "py/ajx2.py",
		data: {"start": $('#i_start').val(),
				 "end": $('#i_end').val(),
				 "pCollect": $('#sel_case').val()
				 },
		//dataType: "json",
		//success: alert(response)
		success: function(response)
		{
			qr = response;
			console.log('you did it');
			$('#results').html(response);
		}
	})
	//.done(function(data){
	//	if ( console && console.log ) {
	//		console.log( "Sample of data:", data.slice( 0, 100 ) );
	//	}
	//});
	return false;
});

$('#search_form').submit(function() {
	if ($('#i_search').val() != '') {
		filterGeometry( $('#i_search').val() );
	} else { alert( "You didn\'t enter a search term"); }
})

// *** map stuff
mapcenter = [38.7138, -9.1394] // Lisbon 38.7138¡ N, 9.1394¡ W
var map = L.map('d_map').setView(mapcenter, 1);
L.tileLayer('http://{s}.tile.cloudmade.com/{key}/{styleId}/256/{z}/{x}/{y}.png',
	{	attribution: 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade',
		key: '96fdfd79055c4839b4dea6ab152710d7',	styleId: 22677, maxZoom: 18
	}).addTo(map);
// ***

var ttPolys, filtered = false, legend_q
dataFile = $("#sel_case").val()
dataLabel = $("#sel_case option:selected").text();
$("#datatitle").html(dataLabel)
$(function(){
	$("#b_search").click( function()
		{ filterGeometry( $('#i_search').val() ) } );
})
updateData = function(d) {
	setDates()
	svg_list.remove(); svg_vis.remove();
	d3.json("data/ttout/"+d+"_geom_d3.json", function(error, json){
		 if (error) {
			alert('that data isn\'t available')
		}
		 ttgeom = json;
		 displayGeometry(ttgeom)
	 })
	 $("#datatitle").html(dataLabel)
	 $('#results').html('')
}
resetGeometry = function() {
	// display all geometry
	svg_vis.selectAll("polygon").attr("display","block");
	// clear search input
	$('#i_search').val('');
	// if there's a filtered legend, remove it
	if(legend_q) { svg_list.remove() }
	// restore initial legend
	displayLegend(tt);
	// reset flag
	filtered = false;
	
}
filterGeometry = function(string){
	$('#results').html("");
	// if filtered already, display all geometry first and remove filtered legend
	if (filtered == true) {
		svg_vis.selectAll("polygon").attr("display","block")
		legend_q.remove()
	} else { legend.remove() } // remove initial legend
	
	// turn off those geometries not matching query
	svg_vis.selectAll("polygon")
		.filter(function(d){return !d.label.match(string)})
		.attr("display","none")
	
	// put data for matched periods in 'q'
	q = legend.selectAll('text')
		.filter(function(d) {return d.label.match(string)}).data()
		
	// make new legend_q group
	legend_q = svg_list.append("g")
		.attr("id","legend_query")
		.attr("class", "legend")
		.attr("height", 100)
		.attr("width", 100)
		//.attr('transform', 'translate(10,20)');
		
	// display text
	legend_q.selectAll('text')
		.data(q)
	.enter()
		.append("text")
		.classed("periodlist",true)
		.attr("x", 32)
		.attr("y", function(d, i){ return i * 20 + 10;})
			 .text(function(d) {return d.label});
			 
	// display rectangles
   legend_q 
		.selectAll('rect')
		.data(q)
	.enter()
		.append("rect")
		.attr("x", 12)
		.attr("y", function(d, i){ return i * 20 ;})
		.attr("width", 10)
		.attr("height", 10)
		.style("fill", function(d) { return color(d.label);})
		.attr("opacity",0.4);
		
	// set flag
	filtered = true;
}
d3.json("data/ttout/"+dataFile+"_geom_d3.json", function(error, json){
	if (error) return console.warn(error)
	//j = json;
	displayGeometry(json)
	console.log('got some data, how\'s it look?');
})

displayLegend = function(data) {
	// add legend   
	svg_list= d3.select("#d_periodlist").append("svg")
		.attr("width", 340)
		.attr("height", 1200);
		
	legend = svg_list.append("g")
	.attr("id","legend_init")
	.attr("class", "legend")
	.attr("height", 100)
	.attr("width", 100)
	//.attr('transform', 'translate(10,20)');
          
   legend 
	.selectAll('rect')
	.data(data)
  .enter()
	.append("rect")
	    .attr("x", 12)
	.attr("y", function(d, i){ return i * 20 ;})
	.attr("width", 10)
	.attr("height", 10)
	.style("fill", function(d) { return color(d.label);})
	.attr("opacity",0.4);
      
   legend.selectAll('text')
		.data(data)
	.enter()
		.append("text")
		.classed("periodlist",true)
		.attr("x", 32)
		.attr("y", function(d, i){ return i * 20 +10;})
			 .text(function(d) {return d.label})
}

displayGeometry = function(ttPolys) {
	tt=ttPolys;
	minx=d3.min(ttPolys, function(d,i) {
		return d3.min(d.points, function(p) {return p.x})})
	maxx=d3.max(ttPolys, function(d,i) {
		return d3.max(d.points, function(p) {return p.x})})
	
	svg_vis = d3.select("#d_geomvis").append("svg")
		.attr("width", 700)
		.attr("height", 120);

	svg_vis_main = svg_vis.append("g")
		.attr("width", 700)
		.attr("height", 100);
	svg_vis_density = svg_vis.append("g")
		.attr("width", 700)
		.attr("height", 20);
	
	scaleX = d3.scale.linear()
        //.domain([2.4299095, 2.4325505])
		.domain([minx,maxx])
        .range([10,700]);

	scaleY = d3.scale.linear()
        .domain([0,1])
        .range([100,25]);
	scaleYme = d3.scale.linear()
        .domain([0,1])
        .range([25,5]);

	color = d3.scale.category10();
	colorY = d3.scale

	svg_vis_main.selectAll("polygon")
    .data(ttPolys)
  .enter().append("polygon")
	.attr("points",function(d) { 
      return d.points.map(function(d) {
			return [scaleX(d.x),scaleY(d.y)].join(","); }).join(" ");})
	.attr("fill", function(d){return color(d.label)})
	.attr("stroke", function(d){return color(d.label)})
	.attr("stroke-width",1)
	//.attr("opacity", 1/svg_vis_main.selectAll("polygon")[0].length)
	.attr("opacity",0.2)
	.attr("y", 10);

	svg_vis_density.selectAll("polygon")
    .data(ttPolys)
  .enter().append("polygon")
	.attr("points",function(d) { 
      return d.points.map(function(d) {
			return [scaleX(d.x),scaleYme(d.y)].join(","); }).join(" ");})
	.attr("fill", "black")
	//.attr("stroke", function(d){return color(d.label)})
	.attr("stroke-width",2)
	.attr("opacity", 1/svg_vis_main.selectAll("polygon")[0].length)
	.attr("y", 10);
	
	displayLegend(ttPolys);
}

</script>
</body>
</html>