<meta charset="utf-8">
<head>
<title>computing place:: topotime alpha0.1</title>
	<link rel="stylesheet" href="css/pepper-grinder/jquery-ui-1.8.23.custom.css" />
	<script src="https://code.jquery.com/jquery-1.9.1.js"></script>
	<script src="https://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
	<script src="js/d3v3/d3.v3.min.js"></script>
	<script src="js/ttdemo.js"></script>
	<link type="text/css" rel="stylesheet" href="css/ttweb.css" />
	<!--<script src="data/out_geom_d3.json"></script>
	<script src="data/polys.js"></script>-->
</head>
<body onload="setDates()">
<h3 id="title"></h3>
<div class="ui-widget" id="left">
	<div class="controls">
	<select id="sel_case">
		<!--# topotime_format pleiades98test Dance us_history ww2b; ORIGINAL tests: ww2a pleiades -->
		<option value="pleiades98test">Pleiades periods</option>
		<option value="topotime_format" selected="selected">Topotime spec</option>
		<option value="Dance">George Dance the Younger</option>
		<option value="us_history">Some U.S. history</option>
		<option value="ww2">A WW II scenario</option>
	</select>
	</div>
	<div class="controls">
		<form id="search_box">
		<p>Query start/end ([-]Y{1,7}[-MM][-DD])</p>
		<p><label for="start">Start date </label>
		<input id="i_start" type="text" name="start" value=""> <br/>
		<label for="end">End date</label>
		<input id="i_end" type="text" name="end" value=""></p>
		<input type="submit" id="b_submit" value="Calculate intersection">
		</form>
		<p id="jQuery_send"></p>
	</div>
	<div><h4>Results</h4><p id="results"></p></div>
</div>
<div id="right">
<div id="geomvis"></div>
<div id="timeline"></div>
</div>
<script>
dateHash={
	"ww2a":{"s":"1945-03-21","e":"1945-09-20"},
	"ww2":{"s":"1945-03-21","e":"1945-09-20"},
	"pleiades":{"s":"-200", "e":"50"},
	"pleiades98test":{"s":"-200", "e":"50"},
	"Dance":{"s":"1761-03-21","e":"1761-09-20"},
	"topotime_format":{"s":"1921-03-21","e":"1921-09-20"},
	"us_history":{"s":"1778-01-01","e":"1800-01-01"}}
	
setDates = function(){
	$('#i_start').val( dateHash[$('#sel_case').val()]['s'] );
	$('#i_end').val( dateHash[$('#sel_case').val()]['e'] );
}
$('#search_box').submit(function() {
	$('#jQuery_send').text("sending: " + $('#i_start').val() + ', ' +
					$('#i_end').val() + ', ' + $('#sel_case').val());
	$.ajax(
		{
		type: "get",
		//ttq5.py; ajx2
		url: "py/ajx2.py",
		data: {"start": $('#i_start').val(),
				 "end": $('#i_end').val(),
				 "pCollect": $('#sel_case').val()
				 },
		success: function(response)
		{
			console.log('you did it')
			$('#results').html(response);
		}
	});
	return false;
});

var ttPolys
dataFile = $("#sel_case").val()
dataLabel=$("#sel_case option:selected").text();
$("#title").html(dataLabel)

updateData = function(d) {
	setDates()
	d3.select("svg").remove()
	d3.json("data/ttout/"+d+"_geom_d3.json", function(error, json){
		 if (error) {
			alert('that data isn\'t available')
		}
		 ttgeom = json;
		 displayGeometry(ttgeom)
	 })
	 $("#title").html(dataLabel)
	 $('#results').html('')
}

d3.json("data/ttout/"+dataFile+"_geom_d3.json", function(error, json){
	if (error) return console.warn(error)
	//j = json;
	displayGeometry(json)
	console.log('got some data, how\'s it look?');
})
getMinMax = function(polys) {
	// var xVals = polys.map(function(obj) { return obj; });
	mins = [], maxs = []
	foo = polys.map(function(obj) { return obj; }).map(function(obj) { return obj.points;});
	for (i in foo) {
		for (j in foo[i]) {
			maxie = Math.max.apply(null, foo[i][j].map(function(item){ return item["x"];}))
			maxs.push(maxie)
			minnie = Math.min.apply(null, foo[i][j].map(function(item){ return item["x"];}))
			mins.push(minnie)
		}
	};
	return [d3.min(mins), d3.max(maxs)]
}
displayGeometry = function(ttPolys) {
	tt=ttPolys;
	minx=getMinMax(ttPolys)[0];
	maxx=getMinMax(ttPolys)[1];
	//minx=d3.min(ttPolys, function(d,i) {
	//	return d3.min(d.points, function(p) {return p.x})})
	//maxx=d3.max(ttPolys, function(d,i) {
	//	return d3.max(d.points, function(p) {return p.x})})
	var vis = d3.select("#geomvis").append("svg")
         .attr("width", 900)
         .attr("height", 400) ;

	scaleX = d3.scale.linear()
        //.domain([2.4299095, 2.4325505])
		.domain([minx,maxx])
        .range([10,700]);
	
	scaleY = d3.scale.linear()
        .domain([0,1])
        .range([300,200]);

	color = d3.scale.category10();

	vis.selectAll("polygon")
    //.data(arrayOfPolygons)
    .data(ttPolys)
    //.data(tt3)
  .enter().append("polygon")
    .attr("points",function(d) { 
        return d.points.map(function(d) { return [scaleX(d.x),scaleY(d.y)].join(","); }).join(" ");})
    .attr("fill", function(d){return color(d.label)})
    .attr("stroke", function(d){return color(d.label)})
    .attr("stroke-width",2)
    .attr("opacity",0.2);

	// add legend   
	var legend = vis.append("g")
	.attr("class", "legend")
	//.attr("x", w - 65)
	//.attr("y", 50)
	.attr("height", 100)
	.attr("width", 100)
	.attr('transform', 'translate(10,20)');
          
    legend 
	.selectAll('rect')
	.data(ttPolys)
	.enter()
	.append("rect")
	    .attr("x", 40)
	.attr("y", function(d, i){ return i *  20;})
	    .attr("width", 10)
	    .attr("height", 10)
	    .style("fill", function(d) { return color(d.label);})
	    .attr("opacity",0.4);
      
    legend.selectAll('text')
	//.data(arrayOfPolygons)
	.data(ttPolys)
	//.data(tt3)
	.enter()
	.append("text")
	    .attr("x", 60)
	.attr("y", function(d, i){ return i *  20 + 9;})
	    .text(function(d) {return d.label});
}
//displayGeometry(dataFile)
</script>
</body>
</html>